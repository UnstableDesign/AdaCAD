<h1>{{filename.value}}</h1>
<div class="project-info">
  <div class="project-info-left">
    <div class="project-name">

      <mat-form-field appearance="outline">
        <mat-label>Workspace Name</mat-label>
        <input matInput [formControl]="filename" placeholder="Enter project name"
          (keyup.enter)="renameWorkspace(filename.value)">
        @if (filename.invalid && (filename.dirty || filename.touched)) {
        <mat-error>
          @if (filename.errors?.['required']) {
          Project name is required
          } @else if (filename.errors?.['minlength']) {
          Project name must be at least 1 character
          }
        </mat-error>
        }



      </mat-form-field>
      @if (filename.dirty) {
      <button mat-raised-button color="accent" (click)="renameWorkspace(filename.value)">
        Save
      </button>
      }

    </div>
    <div class="project-description">

      <mat-form-field appearance="outline">
        <mat-label>Project Description</mat-label>
        <textarea matInput (keyup.enter)="updateWorkspaceDescription(fileDescription.value)"
          [formControl]="fileDescription" placeholder="Enter project description" rows="4"></textarea>
      </mat-form-field>

      @if (fileDescription.dirty) {
      <button mat-raised-button color="accent" (click)="updateWorkspaceDescription(fileDescription.value)">
        Save
      </button>
      }

    </div>
  </div>




  <div class="project-info-right">

    @if(time) {
    <div class="project-created-at">
      <div class='project-info-field'>Last Saved:</div>
      <div class='project-info-value'>{{formatTime(time)}}</div>
    </div>
    }

    <div class="project-id">
      <div class='project-info-field'>AdaCAD Database ID</div>
      <div class='project-info-value'>{{ id }}</div>
    </div>

    @if(from_share) {
    <div class="project-owner">
      <div class='project-info-field'>Shared from</div>
      <div class='project-info-value'>Project Owner</div>
    </div>
    }



    <div class="project-info-actions">
      <button mat-raised-button matTooltip="share" color="primary" (click)="share()">
        <i class="fa-solid fa-share-nodes"></i> Share
      </button>

    </div>


  </div>

</div>

<!-- Media Section -->
<section class="media-section">
  <h2>Media</h2>
  <div class="media-grid">
    @for (mediaItem of media; track mediaItem.id) {
    <div class="media-card">
      <div class="media-thumbnail">
        <img [src]="mediaItem.img.image.src" [alt]="mediaItem.img.name || 'Media item'"
          (error)="$event.target.style.display='none'">
      </div>
      <div class="media-info">
        <div class="media-name">{{ mediaItem.img.name || 'Unnamed Media' }}</div>
        <div class="media-type">
          <mat-chip [color]="mediaItem.type === 'indexed_color_image' ? 'primary' : 'accent'" selected>
            {{ mediaItem.type === 'indexed_color_image' ? 'Indexed Color' : 'Image' }}
          </mat-chip>
        </div>
        <div class="media-dimensions">
          {{ mediaItem.img.width }} Ã— {{ mediaItem.img.height }}px
        </div>
      </div>
    </div>
    }
  </div>
  @if (media.length === 0) {
  <p class="empty-message">No media uploaded to this workspace.</p>
  }
</section>

<!-- Drafts Section -->
<section class="drafts-section">
  <h2>Drafts</h2>
  <div class="draft-actions">
    @if (draftsData.length > 0) {




    <button mat-raised-button color="primary" (click)="downloadAllDraftsAsBitmaps()">
      <i class="fas fa-download"></i>
      @if (getSelectedDraftsCount() > 0) {
      Download Selected Drafts as Bitmaps
      } @else {
      Download All Drafts as Bitmaps
      }
    </button>

    @if (getSelectedDraftsCount() > 0) {
    <button mat-raised-button color="primary" (click)="downloadAllDraftsAsBitmaps()">
      <i class="fas fa-eye-slash"></i>
      Hide Selected Drafts
    </button>
    }
    }

    <button mat-raised-button>
      <i class="fas fa-upload"></i>
      Import Bitmaps
    </button>
  </div>


  <div>
    <div class="drafts-grid">
      @for(draft of draftsData; track draft.uid) {
      <app-draftinfocard [id]="draft.id" (onDraftSelectionChange)="toggleDraftSelection($event)"></app-draftinfocard>
      <!-- <div class="draft-card" [formGroupName]="$index">
        <div class="draft-checkbox" (click)="$event.stopPropagation()">
          <input type="checkbox" [checked]="isDraftSelected(draft.get('id')?.value)"
            (change)="toggleDraftSelection(draft.get('id')?.value)" [id]="'draft-' + draft.get('id')?.value">
          <label [for]="'draft-' + draft.get('id')?.value"></label>
        </div>
        <div class="draft-type-icon"
          [matTooltip]="isSeedDraft(draft.get('id')?.value) ? 'Seed Draft' : 'Generated by Operation'">
          @if (isSeedDraft(draft.get('id')?.value)) {
          <i class="fas fa-seedling"></i>
          } @else {
          <i class="fas fa-code"></i>
          }
        </div>
        <div class="draft-name">

          <mat-form-field appearance="outline">
            <mat-label>Draft Name</mat-label>
            <input matInput formControlName="name">
          </mat-form-field>
        </div>
        <div class="draft-thumbnail">
          <app-draft-rendering source="library" [id]="draft.get('id')?.value" [view_only]="true" [scale]="0.15"
            [oversize]="draftsData[$index]?.oversize" current_view="drawdown">
          </app-draft-rendering>
        </div>

        @if (draftsData[$index]?.color) {
        <div class="draft-color">
          {{draftsData[$index]?.color}}
        </div>
        }
        <div class="draft-warps">
          {{draftsData[$index]?.warps}} x {{draftsData[$index]?.wefts}}
        </div>


        <div class="draft-notes">
          <mat-form-field appearance="outline">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" class="draft-notes-input"></textarea>
          </mat-form-field>
        </div>



        <div class="draft-loom">
          <div class="draft-loom-thumbnail">
            <mat-form-field appearance="outline">
              <mat-label>warp density</mat-label>
              <input matInput formControlName="loom_epi" type="number" min="0">
            </mat-form-field>

          </div>
          <div class="draft-loom-thumbnail">
            <mat-form-field appearance="outline">
              <mat-label>weft density</mat-label>
              <input matInput formControlName="loom_ppi" type="number" min="0">
            </mat-form-field>
          </div>

        </div>

        <div class="draft-actions">
          <button matIconButton matTooltip="download draft" (click)="downloadDraft(draft.get('id')?.value)">
            <i class="fas fa-download"></i>
          </button>
          <button matIconButton matTooltip="open in mixer" (click)="downloadDraft(draft.get('id')?.value)">
            <i class="fa-code-branch fa-solid"></i>
          </button>
          <button matIconButton matTooltip="open in editor" (click)="downloadDraft(draft.get('id')?.value)">
            <i class="fa-pen-to-square fa-solid"></i>
          </button>
        </div>
      </div> -->
      }
    </div>
  </div>

  @if (draftsData.length === 0) {
  <p class="empty-message">No drafts in this workspace.</p>
  }
</section>

<!-- Materials Section -->
<section class="materials-section">
  <h2>Materials</h2>

  <div class="materials-actions">
    <button mat-raised-button color="primary" (click)="exportMaterialsAsCSV()">
      <i class="fas fa-download"></i>
      Export Materials as CSV
    </button>
    <button mat-raised-button (click)="triggerCSVImport()">
      <i class="fas fa-upload"></i>
      Import Materials from CSV
    </button>
  </div>

  <app-material #materials></app-material>

</section>

<!-- Hidden canvas for downloading drafts -->
<canvas #hiddenCanvas style="display: none;"></canvas>

<!-- Hidden file input for CSV import -->
<input #csvFileInput type="file" accept=".csv" style="display: none;" (change)="onCSVFileSelected($event)">