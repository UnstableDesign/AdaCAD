<div class="library-container">
  <h1>Library</h1>

  <!-- Drafts Section -->
  <section class="drafts-section">
    <h2>Drafts</h2>
    <div class="drafts-grid">
      @for (draft of drafts; track draft.id) {
      <div class="draft-card">
        <div class="draft-checkbox" (click)="$event.stopPropagation()">
          <input type="checkbox" [checked]="isDraftSelected(draft.id)" (change)="toggleDraftSelection(draft.id)"
            [id]="'draft-' + draft.id">
          <label [for]="'draft-' + draft.id"></label>
        </div>
        <div class="draft-type-icon" [matTooltip]="isSeedDraft(draft.id) ? 'Seed Draft' : 'Generated by Operation'">
          @if (isSeedDraft(draft.id)) {
          <i class="fas fa-seedling"></i>
          } @else {
          <i class="fas fa-code"></i>
          }
        </div>
        <div class="draft-thumbnail">
          <app-draft-rendering source="library" [id]="draft.id" [view_only]="true" [scale]="0.15"
            [current_view]="'drawdown'">
          </app-draft-rendering>
        </div>
        <div class="draft-name">
          <input type="text" [value]="draft.name" (blur)="onDraftNameChange(draft.id, $any($event.target).value)"
            (keyup.enter)="onDraftNameChange(draft.id, $any($event.target).value); $event.target.blur()"
            (keyup.escape)="$event.target.blur()" class="draft-name-input">
        </div>
        @if (!isSeedDraft(draft.id)) {
        <div class="draft-operations">
          <div class="operations-label">created by:</div>
          <div class="operations-list">
            @for (op of getDraftOperations(draft.id); track $index) {
            <span class="operation-tag" [style.background-color]="op.color">{{ op.displayName }}</span>
            @if (!$last) {
            <span class="operation-arrow">→</span>
            }
            }
          </div>
        </div>
        }
        @if (getDraftUsedBy(draft.id).length > 0) {
        <div class="draft-operations">
          <div class="operations-label">used by:</div>
          <div class="operations-list">
            @for (op of getDraftUsedBy(draft.id); track $index) {
            <span class="operation-tag" [style.background-color]="op.color">
              {{ op.displayName }}@if (op.inletLabel) { ({{ op.inletLabel }}) }
            </span>
            @if (!$last) {
            <span class="operation-arrow">→</span>
            }
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
    @if (drafts.length > 0) {
    <div class="download-section">
      <button mat-raised-button color="primary" (click)="downloadAllDraftsAsBitmaps()">
        <i class="fas fa-download"></i>
        @if (getSelectedDraftsCount() > 0) {
        Download Selected Drafts as Bitmaps
        } @else {
        Download All Drafts as Bitmaps
        }
      </button>
    </div>
    }
    @if (drafts.length === 0) {
    <p class="empty-message">No drafts in this workspace.</p>
    }
  </section>

  <!-- Materials Section -->
  <section class="materials-section">
    <h2>Materials</h2>
    <div class="materials-grid">
      @for (material of materials; track material.id) {
      <div class="material-card">
        <div class="material-color" [style.background-color]="material.color"></div>
        <div class="material-info">
          <div class="material-name">{{ material.name }}</div>
          <div class="material-diameter">Diameter: {{ material.diameter }}mm</div>
          @if (material.notes && material.notes.trim() !== '') {
          <div class="material-notes">{{ material.notes }}</div>
          }
        </div>
      </div>
      }
    </div>
    @if (materials.length === 0) {
    <p class="empty-message">No materials in this workspace.</p>
    }
  </section>
</div>

<!-- Hidden canvas for downloading drafts -->
<canvas #hiddenCanvas style="display: none;"></canvas>