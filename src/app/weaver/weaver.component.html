<app-topbar 
[undoItem]="undoItem" 
[redoItem]="redoItem"
  (onUndo)="undo();" 
  (onRedo)="redo();"
  (onSave)="onSave($event);">
</app-topbar>


<mat-sidenav-container class="example-container">
  <mat-sidenav mode="side" position="end" opened>

    <div class="view-toggle">
    

    <mat-slider thumbLabel [displayWith]="formatLabel" tickInterval="1" min="1" max="100" value="{{render.zoom}}" (change)="renderChange($event)"></mat-slider>
    

    <mat-button-toggle-group #group [value]="view" (change)="viewChange($event);">
      <mat-button-toggle value="pattern">
        <i class="fa fa-chess-board" aria-hidden="true"></i>
        Draft
      </mat-button-toggle>
      <mat-button-toggle value="yarn">
        <i class="fa fa-project-diagram" aria-hidden="true"></i>
        Yarn
      </mat-button-toggle>
      <mat-button-toggle value="visual">
        <i class="fa fa-image" aria-hidden="true"></i>
        Visual
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

    <mat-tab-group #group (click)="selected = group.selectedIndex;">
      <mat-tab label="Design">
        <app-design [brush]="brush" [favorites]="draft?.patterns | filter: {favorite: true}"
        (onBrushChange)="onBrushChange($event)" 
        (onFill)="onFill($event)" 
        (onCopy)="onCopy();"
        (onClear)="onClear();" 
        (onMask)="onMask($event);" 
        (onPaste)="onPaste($event);"
        (onConnectionCreate)="openConnectionDialog();"
        (onLabelCreate)="openLabelDialog()"></app-design> 
      </mat-tab>
      <mat-tab label="Materials">
        <app-shuttles *ngIf="selected === 1" 
        [shuttles]="draft?.shuttles" 
        [warp_systems]="draft?.warp_systems" 
        [warps]="draft?.warps" 
        [epi]="draft?.epi" 
        [show_frames] = "show_frames"
        (onColorChange)="redraw()"
        (onCreateShuttle)="createShuttle($event);"
        (onCreateWarpSystem)="createWarpSystem($event);"
        (onHideShuttle)="hideShuttle($event);"
        (onShowShuttle)="showShuttle($event);"
        (onWarpNumChange) = "warpNumChange($event)"
        (onEpiNumChange) = "epiChange($event)">
          
        </app-shuttles> 

      </mat-tab>
      <mat-tab label="Patterns">
        <app-patterns *ngIf="selected === 2" [patterns]="draft?.patterns"
        (onChange)="updatePatterns($event);"
        (onCreatePattern)="createPattern($event);"
        (onRemovePattern)="removePattern($event);"></app-patterns>  
      </mat-tab>
    </mat-tab-group>
  </mat-sidenav>


  <mat-sidenav-content>


    <div *ngIf="draft" #weaveRef weave [render]="render" [(brush)]="brush" width="500" height="500" [draft]="draft" class="draft-container">


      <div class="weftSelections">

        <div  matTooltip="Show/Hide Threading, Tie-Up, and Treadling" class="view_frames" 
        [ngStyle]="styleViewFrames(threading)" (click)="view_frames = !view_frames; styleDrawdown(threading)">
        <span><i class="fas" [class.fa-eye-slash]="!view_frames" [class.fa-eye]="view_frames"> 
        </i></span>
        </div>



        <svg #shuttles class="shuttles" [ngStyle]="styleWeftShuttles(threading)">
          <g *ngFor="let i of (draft?.visibleRows); let j = index;" >
            <circle cx="20" [attr.cy]="styleShuttleRow(j)" r="7" stroke="white" stroke-width="1" [attr.fill]="draft?.shuttles[draft.rowToShuttle(i)]?.color" (click)="rowShuttleChange(i, j)"/>
            <text text-anchor="end" x="5" [attr.y]="styleShuttleRow(j)" style="font-size:12px;" fill="#fff">{{ i + 1 }}</text>
          </g>
        </svg>

        <svg #warp_systems class="warp_systems" [ngStyle]="styleWarpSystems(threading)">
          <g *ngFor="let i of (draft?.colShuttleMapping); let j = index;" >
            <circle cy="20" [attr.cx]="styleShuttleRow(j)" r="7" stroke="white" stroke-width="1" [attr.fill]="draft?.warp_systems[i]?.color" (click)="colShuttleChange(j)"/>
            <text text-anchor="end" y="5" [attr.x]="styleShuttleRow(j)" style="font-size:12px;" fill="#fff">{{ j + 1 }}</text>
          </g>
        </svg>  



        <div  #insertButtons class="insert-button-group" [ngStyle]="styleRowButtons(threading)" >
          <div *ngFor="let i of (draft?.visibleRows)" class="insert-button">
            <span (click)="insertRow(i + 1, draft?.rowToShuttle(i));"><i class="fa fa-plus-circle"></i></span>
            <span (click)="cloneRow(i + 1, i, draft?.rowToShuttle(i));"><i class="fa fa-clone"></i></span>
            <span (click)="deleteRow(i);"><i class="fa fa-trash"></i></span>
          </div>
        </div>


        <svg #mySelection class="selection">
          <text x="5" y="5" text-anchor="start"></text>
        </svg>
      
      </div>
        

      <div  [style.visibility]="view_frames ? 'visible' : 'hidden'" #threadref class="threading-container"  #threading>
        <canvas #threading [ngStyle]="styleThreading()"></canvas>
      </div>


       <div  [style.visibility]="view_frames ? 'visible' : 'hidden'" #tieupsref class="tieups-container" [ngStyle]="styleTieUps(threading)">
      <canvas #tieups style="background:#fbfbfb;"></canvas>
      </div>

      <div class='drawdown-container' [ngStyle]="styleDrawdown(threading)">
      <canvas #drawDown style="background:#fbfbfb;">  </canvas>
      </div>


      
      <div  [style.visibility]="view_frames ? 'visible' : 'hidden'" #treadref class="treadling-container" [ngStyle]="styleTreadling(threading)">
      <canvas #treadling style="background:#fbfbfb;"></canvas>
    </div>


      <canvas #bitmapImage hidden></canvas>

<!--       <svg #connections [style.left]="drawDown.offsetLeft" [attr.width]="draft?.warps * 20" [attr.height]="draft?.wefts * 20" style="position:absolute" [class.hidden]="view !== 'yarn'">
        <g *ngFor="let c of (draft?.connections)">
          <line 
          [attr.x1]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.y1]="c.start.y * 20 - 10"       
          [attr.x2]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.y2]="c.end.y * 20 - 10"
          [attr.stroke]="draft?.shuttles[c.shuttleId]?.color"
          stroke-width="5"/>
          <circle 
          [attr.cx]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.cy]="c.start.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
          <circle
          [attr.cx]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.cy]="c.end.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
        </g>
      </svg> -->



    </div>


  </mat-sidenav-content>
</mat-sidenav-container>
