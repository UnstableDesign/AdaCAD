<app-topbar 
[timeline] = "timeline"
[undoItem]="undoItem" 
[redoItem]="redoItem"
[draftelement]="draftelement"
  (onUndo)="undo();" 
  (onRedo)="redo();"
  (onSave)="onSave($event);">

</app-topbar>


<mat-sidenav-container class="example-container">
  
  <mat-sidenav mode="side" position="end" opened>
    
      <div class ="design-container" [class.collapsed]="collapsed">
        <mat-accordion multi>



<!--         <button
           (click)="toggleCollapsed()"
            class="collapse" 
            value="collapsed">
         <i class="fa"
           [class.fa-angle-double-right]="!collapsed" 
           [class.fa-angle-double-left]="collapsed"
         aria-hidden="true"></i>
        </button>
 -->


          <app-view 
            [view_modes] = "view_modes"
            [zoom] = "render?.zoom"
            [view] ="render?.current_view"
            (onViewChange) ="viewChange($event);"
            (onZoomChange) ="renderChange($event);"
          >
          </app-view>


        <app-design [hidden] = "render?.current_view == 'mask'"
        [brush]="brush"
        [favorites]="draft?.patterns | filter: {favorite: true}"
        (onBrushChange)="onBrushChange($event)" 
        (onFill)="onFill($event)" 
        (onCopy)="onCopy();"
        (onClear)="onClear();" 
        (onPaste)="onPaste($event);"
      
        >
        </app-design> 
 


        <app-weftsystems [hidden] = "render?.current_view != 'pattern'"
          [shuttles] = "draft?.shuttles"
          [warps]="warps" 
          (onCreateShuttle)="createShuttle($event);"
          (onHideShuttle)="hideShuttle($event);"
          (onShowShuttle)="showShuttle($event);"
           >
        </app-weftsystems>


        <app-warpsystems [hidden] = "render?.current_view != 'pattern'"
          [warp_systems]="draft?.warp_systems" 
          [warps]="warps" 
          (onCreateWarpSystem)="createWarpSystem($event);"
          (onHideShuttle)="hideShuttle($event);"
          (onShowShuttle)="showShuttle($event);">
        </app-warpsystems>

        <app-materials 
          [material_types]="material_types"
          [materials]="draft?.materials"
          (onColorChange)="redraw()" 
          (onThicknessChange) ="thicknessChange($event)"
          (onCreateMaterial) ="createMaterial($event)"
        >

        </app-materials>

        <app-masks [hidden] = "render?.current_view != 'mask'"
          (onMask)="onMask($event);" >
        </app-masks>

        <app-patterns [hidden] = "render?.current_view != 'pattern'"
          [patterns]="draft?.patterns"
          (onPatternChange)="updatePatterns($event);"
          (onCreatePattern)="createPattern($event);"
          (onRemovePattern)="removePattern($event);"
          (onChange) = "onChange($event);">
          >
        </app-patterns>

        <app-loom 
          [epi] = "draft?.epi"
          [warps] = "draft?.warps"
          [wefts] = "draft?.wefts"
          [frames] = "draft?.loom.min_frames"
          [treadles] = "draft?.loom.min_treadles"
          [loomtypes] = "loomtypes"
          [loomtype] = "draft?.loom.type"
          [density_units] = "density_units"
          [units] = "draft?.units"
          [width] = "draft?.width"
          (onWarpNumChange) = "warpNumChange($event)"
          (onWeftNumChange) = "weftNumChange($event)"
          (onEpiNumChange) = "epiChange($event)"
          (onUnitChange) = "unitChange($event)"
          (onThicknessChange) = "thicknessChange($event)"
          (onLoomTypeChange) = "loomChange($event)"
          (onFrameChange) = "frameChange($event)"
          (onTreadleChange) = "treadleChange($event)"
          >
        </app-loom>

        <app-schematic  [hidden] = "render?.current_view != 'yarn'"
        (onConnectionCreate)="openConnectionDialog();"
        (onLabelCreate)="openLabelDialog()"
        >

      </app-schematic> 
    </mat-accordion>

    </div>

  </mat-sidenav>


  <mat-sidenav-content>


    <div *ngIf="draft" #weaveRef weave [render]="render" [timeline]="timeline" [(brush)]="brush" width="500" height="500" [draft]="draft" class="draft-container">


      <div class="weftSelections">

        <div [class.hidden]="draft?.loom.type !== 'frame'"  matTooltip="Show/Hide Threading, Tie-Up, and Treadling" class="view_frames" 
        [ngStyle]="styleViewFrames(threading)" (click)="toggleViewFrames(); styleDrawdown(threading)">
        <span><i class="fas" [class.fa-eye-slash]="!render?.view_frames" [class.fa-eye]="render?.view_frames">
        </i></span>
        </div>

         <div class="shuttles" [ngStyle]="styleWeftShuttles(threading)">
          <canvas id="weft-systems" #weftSystems style="background:#fbfbfb;">  </canvas>
         </div>

         <div class="shuttles-text">
          <svg class="shuttle-text" [ngStyle]="styleWeftShuttleText(threading)">
            <g *ngFor="let i of (draft?.visibleRows); let j = index;" >
            
            <text class="weft_text" 
            text-anchor="middle" x="0" [attr.y]="styleShuttleRow(j)" style="font-size:12px;"     fill="#fff" 
            [style.visibility]="(i % render?.getTextInterval() == 0)  ? 'visible' : 'hidden'">{{i}}</text> 
            </g>

          <text class="weft_text" 
          text-anchor="middle" x="0" [attr.y]="styleShuttleRow(draft?.visibleRows.length)" style="font-size:12px;" fill="#fff" >{{draft?.visibleRows[draft?.visibleRows.length-1]+1}}</text> 
        </svg> 

        </div>



        <div class="warp-systems" [ngStyle]="styleWarpSystems(threading)">
          <canvas id="warp-systems"#warp_systems style="background:#fbfbfb;">  </canvas>
        </div>

        <div class='warp-systems-text' [ngStyle]="styleWarpSystemsText(threading)">
          
            <svg class="warp-systems-text">

            <g *ngFor="let i of (draft?.colShuttleMapping); let j = index;" >
              <text  [attr.transform]="getTransform(j)" text-anchor="start" y="0"
               [style.visibility]="(j % render?.getTextInterval() == 0)  ? 'visible' : 'hidden'"style="font-size:12px;" fill="#fff">{{j}}</text>
            </g>
             <text class="warp_text" text-anchor="start" y="0" [attr.transform]="getTransform(draft?.colShuttleMapping.length)" 
              style="font-size:12px;" fill="#fff">{{draft?.colShuttleMapping.length}}</text>
           </svg>  
      </div> 







        <div  #shuttle_buttons class="insert-button-group-shuttles" [ngStyle]="styleRowButtons(threading, shuttle_buttons)" >
          <div *ngFor="let i of (draft?.visibleRows)" class="insert-button" [ngStyle]="styleSingleRowButton(i)">
            <span (click)="insertRow(i + 1, draft?.rowToShuttle(i), draft?.rowToMaterial(i));"><i class="fa fa-plus-circle"></i></span>
            <span (click)="cloneRow(i + 1, i, draft?.rowToShuttle(i),draft?.rowToMaterial(i));"><i class="fa fa-clone"></i></span>
            <span (click)="deleteRow(i);"><i class="fa fa-trash"></i></span>
          </div>
        </div>

        <div class="insert-button-group-warps" [ngStyle]="styleColButtons(threading)" >
          <div *ngFor="let m of (draft?.colShuttleMapping); index as i;" class="insert-button" [ngStyle] = "styleSingleColButton(i)">
            <span (click)="insertCol(i + 1, draft?.colToShuttle(i),draft?.colToMaterial(i));"><i class="fa fa-plus-circle"></i></span>
            <span (click)="cloneCol(i,draft?.colToShuttle(i), draft?.colToMaterial(i));"><i class="fa fa-clone"></i></span>
            <span (click)="deleteCol(i);"><i class="fa fa-trash"></i></span>
          </div>
        </div>




        <svg #mySelection class="selection">
          <text x="5" y="5" text-anchor="start"></text>
        </svg>
      
      </div>
        

      <div  [style.visibility]="render?.view_frames ? 'visible' : 'hidden'" #threadref class="threading-container"  #threading [ngStyle]="styleThreading()">
        <canvas id="threading"></canvas>
      </div>


       <div  [style.visibility]="render?.view_frames ? 'visible' : 'hidden'" #tieupsref class="tieups-container" [ngStyle]="styleTieUps(threading)">
      <canvas id="tieups" #tieups style="background:#fbfbfb;"></canvas>
      </div>

      <div class='drawdown-container' [ngStyle]="styleDrawdown(threading)">
      <canvas id="drawdown" #drawDown style="background:#fbfbfb;">  </canvas>
      </div>

      
      <div  [style.visibility]="render?.view_frames ? 'visible' : 'hidden'" #treadref class="treadling-container" [ngStyle]="styleTreadling(threading)">
      <canvas #treadling id="treadling" style="background:#fbfbfb;"></canvas>
    </div>


      <canvas #bitmapImage hidden></canvas>

<!--       <svg #connections [style.left]="drawDown.offsetLeft" [attr.width]="draft?.warps * 20" [attr.height]="draft?.wefts * 20" style="position:absolute" [class.hidden]="view !== 'yarn'">
        <g *ngFor="let c of (draft?.connections)">
          <line 
          [attr.x1]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.y1]="c.start.y * 20 - 10"       
          [attr.x2]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.y2]="c.end.y * 20 - 10"
          [attr.stroke]="draft?.shuttles[c.shuttleId]?.color"
          stroke-width="5"/>
          <circle 
          [attr.cx]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.cy]="c.start.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
          <circle
          [attr.cx]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.cy]="c.end.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
        </g>
      </svg> -->



    </div>


  </mat-sidenav-content>
</mat-sidenav-container>
