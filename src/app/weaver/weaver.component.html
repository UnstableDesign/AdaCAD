<app-topbar 
[drawer] = "drawer"
[loomtypes] = "loomtypes"
[timeline] = "timeline"
[density_units] = "density_units"
[undoItem]="undoItem" 
[redoItem]="redoItem"
[filename]="draft?.name"
[draftelement]="draftelement"
  (onUndo)="undo();" 
  (onRedo)="redo();"
  (onReInit)="reInit($event);"
  (onSave)="onSave($event);">
</app-topbar>

<mat-drawer-container class="mat-drawer-container">
  
  <mat-drawer #drawer class="example-sidenav" mode="side" position="end" opened>  

      <div class ="design-container">
       
        <mat-accordion multi>

        <app-view 
          [weft_systems] = "draft?.weft_systems"
          [warp_systems]="draft?.warp_systems" 
          [front] = "render?.view_front"
          [view_modes] = "view_modes"
          [zoom] = "render?.zoom"
          [view] ="render?.current_view"
          (onViewChange) ="viewChange($event);"
          (onZoomChange) ="renderChange($event);"
          (onViewFront) ="renderChange($event);"
          (onHideWeftSystem)="hideWeftSystem($event);"
          (onShowWeftSystem)="showWeftSystem($event);"
          (onHideWarpSystem)="hideWarpSystem($event);"
          (onShowWarpSystem)="showWarpSystem($event);"
        >


        </app-view>


        <app-design
        [design_mode]="design_mode"
        [design_modes]="design_modes"
        [design_actions]="design_actions"
        [view_mode] = "render?.current_view"
        [materials]="draft?.shuttles"
        [patterns]="draft?.patterns"
        [selection] = "copy"
        (onDesignModeChange)="onDesignModeChange($event)" 
        (onFill)="onFill($event)" 
        (onCopy)="onCopy();"
        (onClear)="onClear($event);" 
        (onPaste)="onPaste($event);"
        (onPatternChange)="updatePatterns($event);"
        (onCreatePattern)="createPattern($event);"
        (onRemovePattern)="removePattern($event);"
        (onChange) = "onChange($event);"
      
        >
        </app-design> 
 
        <app-materials 
          [material_types]="material_types"
          [shuttles]="draft?.shuttles"
          (onColorChange)="shuttleColorChange()" 
          (onThicknessChange) ="thicknessChange($event)"
          (onCreateShuttle) ="createShuttle($event)"
        >

        </app-materials>

        <app-masks [hidden] = "render?.current_view != 'mask'"
          (onMask)="onMask($event);" >
        </app-masks>

        <app-systems
         [weft_systems]="draft?.weft_systems"
         [warp_systems]="draft?.warp_systems"
         [weft_systems_pattern]="draft?.rowSystemPattern"
         [warp_systems_pattern]="draft?.colSystemPattern"
         [shuttles]="draft?.shuttles"
         [warp_shuttles_pattern]="draft?.colShuttlePattern"
         [weft_shuttles_pattern]="draft?.rowShuttlePattern"
         (onUpdateWarpSystems) = "updateWarpSystems($event)"
         (onUpdateWeftSystems) = "updateWeftSystems($event)"
         (onUpdateWarpShuttles) = "updateWarpShuttles($event)"
         (onUpdateWeftShuttles) = "updateWeftShuttles($event)"
        >
       </app-systems>


        <app-loom 
          [epi] = "draft?.epi"
          [warps] = "draft?.warps"
          [wefts] = "draft?.wefts"
          [frames] = "draft?.loom.min_frames"
          [treadles] = "draft?.loom.min_treadles"
          [loomtypes] = "loomtypes"
          [loomtype] = "draft?.loom.type"
          [density_units] = "density_units"
          [units] = "draft?.units"
          [width] = "draft?.width"
          (onWarpNumChange) = "warpNumChange($event)"
          (onWeftNumChange) = "weftNumChange($event)"
          (onEpiNumChange) = "epiChange($event)"
          (onUnitChange) = "unitChange($event)"
          (onThicknessChange) = "thicknessChange($event)"
          (onLoomTypeChange) = "loomChange($event)"
          (onFrameChange) = "frameChange($event)"
          (onTreadleChange) = "treadleChange($event)"
          >
        </app-loom>

        <app-notes
         [notes] = "draft?.notes"
         (onChange) = "notesChanged($event)"
         >
        </app-notes>

        <app-schematic  [hidden] = "render?.current_view != 'yarn'"
        (onConnectionCreate)="openConnectionDialog();"
        (onLabelCreate)="openLabelDialog()"
        >

      </app-schematic> 


    </mat-accordion>

    </div>

  </mat-drawer>



  <div #weaveRef weave [render]="render" [(design_mode)]="design_mode" [(copy)]="copy" [timeline]="timeline" width="500" height="500" [draft]="draft" class="draft-container" id="draft-container" (onNewSelection) = "updateSelection($event)">




  
   <canvas id="weft-systems" #weft_systems>  </canvas>
   <canvas id="weft-materials" #weft_materials>  </canvas>
  
   <canvas id="warp-systems" #warp_systems>  </canvas>
   <canvas id="warp-materials" #warp_materials>  </canvas>
  
   <canvas id="threading"></canvas>
   <canvas id="tieups" #tieups ></canvas>
   <canvas id="drawdown" #drawDown >  </canvas>
   <canvas id="treadling" #treadling></canvas>


    <svg #mySelection class="selection">
      <text x="5" y="5" text-anchor="start"></text>
    </svg>
              



    <div [class.hidden]="draft?.loom.type !== 'frame'"  matTooltip="Show/Hide Threading, Tie-Up, and Treadling" class="view_frames" 
   (click)="toggleViewFrames(); styleDrawdown(threading)">

      <span><i class="fas" [class.fa-eye-slash]="!render?.view_frames" [class.fa-eye]="render?.view_frames">
      </i></span>

    </div>

         
  <svg class="weft-systems-text">
    <g *ngFor="let i of (draft?.visibleRows); let j = index;" >
    
      <text class="weft_text" 
      text-anchor="middle" x="40" [attr.y]="styleWeftSystemsRow(j)" style="font-size:12px;"     fill="#fff" 
      [style.visibility]="(i % render?.getTextInterval() == 0)  ? 'visible' : 'hidden'">{{i}}</text> 
      
      <text id='weft-systems' 
        [attr.transform]="getWeftSystemTransform(j)" 
        [attr.font-size]="getSelectorFontSize()"
        text-anchor="start" 
        fill="#fff">{{draft?.getWeftSystemCode(j)}}</text>

    </g>

    <text class="weft_text" 
    text-anchor="middle" x="0" [attr.y]="styleWeftSystemsRow(draft?.visibleRows.length)" style="font-size:12px;" fill="#fff" >{{draft?.visibleRows[draft?.visibleRows.length-1]+1}}</text> 
   </svg> 



      
    <svg class="warp-systems-text">

    <g *ngFor="let i of (draft?.colShuttleMapping); let j = index;" >
      <text  [attr.transform]="getTransform(j)" text-anchor="start" y="0"
       [style.visibility]="(j % render?.getTextInterval() == 0)  ? 'visible' : 'hidden'"style="font-size:12px;" fill="#fff">{{j}}</text>

      <text id='warp-systems' 
      [attr.transform]="getWarpSystemTransform(j)" 
      [attr.font-size]="getSelectorFontSize()"
      text-anchor="start"  y="0"
      fill="#fff">{{draft?.getWarpSystemCode(j)}}</text>
    </g>


   <text class="warp_text" text-anchor="start" y="0" [attr.transform]="getTransform(draft?.colShuttleMapping.length)" 
    style="font-size:12px;" fill="#fff">{{draft?.colShuttleMapping.length}}</text>
   </svg>  



    <div  #shuttle_buttons class="insert-button-group-shuttles" >
      <div *ngFor="let r of (draft?.visibleRows); index as i; " class="insert-button"  [ngStyle]="styleSingleRowButton(i)">
        <span (click)="insertRow(r + 1, draft?.rowToShuttle(r), draft?.rowToSystem(r));"><i class="fa fa-plus-circle"></i></span>
        <span (click)="cloneRow(r + 1, r, draft?.rowToShuttle(r),draft?.rowToSystem(r));"><i class="fa fa-clone"></i></span>
        <span (click)="deleteRow(r);"><i class="fa fa-trash"></i></span>
      </div>
    </div>


    <div class="insert-button-group-warps" >
      <div *ngFor="let m of (draft?.colShuttleMapping); index as i;" class="insert-button" [ngStyle] = "styleSingleColButton(i)">
        <span (click)="insertCol(i + 1, draft?.colToShuttle(i),draft?.colToSystem(i));"><i class="fa fa-plus-circle"></i></span>
        <span (click)="cloneCol(i,draft?.colToShuttle(i), draft?.colToSystem(i));"><i class="fa fa-clone"></i></span>
        <span (click)="deleteCol(i);"><i class="fa fa-trash"></i></span>
      </div>
    </div>




    <canvas #bitmapImage hidden></canvas>

<!--       <svg #connections [style.left]="drawDown.offsetLeft" [attr.width]="draft?.warps * 20" [attr.height]="draft?.wefts * 20" style="position:absolute" [class.hidden]="view !== 'yarn'">
        <g *ngFor="let c of (draft?.connections)">
          <line 
          [attr.x1]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.y1]="c.start.y * 20 - 10"       
          [attr.x2]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.y2]="c.end.y * 20 - 10"
          [attr.stroke]="draft?.shuttles[c.shuttleId]?.color"
          stroke-width="5"/>
          <circle 
          [attr.cx]="c.start.x === 1? c.start.x * 20 - 15 : c.start.x * 20 - 5" 
          [attr.cy]="c.start.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
          <circle
          [attr.cx]="c.end.x === 1? c.end.x * 20 - 15 : c.end.x * 20 - 5"
          [attr.cy]="c.end.y * 20 - 10" r="7" 
          [attr.fill]="draft?.shuttles[c.shuttleId]?.color"/>
        </g>
      </svg> -->



  </div>


</mat-drawer-container>
